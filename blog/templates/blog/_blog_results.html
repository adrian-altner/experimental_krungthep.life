{% load wagtailcore_tags wagtailimages_tags wagtailroutablepage_tags %}

<div id="blog-results">
    {% if categories or tags or authors %}
        <div class="mt-8 space-y-6">
            {% if categories %}
                <div class="space-y-3">
                    <h2 class="text-xs font-semibold uppercase tracking-wider text-[#c4582f]">Categories</h2>
                    <div class="flex flex-wrap gap-2">
                        <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if not active_category %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?{% if active_tag %}tag={{ active_tag }}{% endif %}{% if active_tag and active_author %}&{% endif %}{% if active_author %}author={{ active_author }}{% endif %}" hx-get="?{% if active_tag %}tag={{ active_tag }}{% endif %}{% if active_tag and active_author %}&{% endif %}{% if active_author %}author={{ active_author }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                            All
                        </a>
                        {% for category in categories %}
                            <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if active_category == category.slug %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?category={{ category.slug }}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if active_author %}&author={{ active_author }}{% endif %}" hx-get="?category={{ category.slug }}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if active_author %}&author={{ active_author }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                                {{ category.title }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if tags %}
                <div class="space-y-3">
                    <h2 class="text-xs font-semibold uppercase tracking-wider text-[#c4582f]">Tags</h2>
                    <div class="flex flex-wrap gap-2">
                        <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if not active_tag %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?{% if active_category %}category={{ active_category }}{% endif %}{% if active_category and active_author %}&{% endif %}{% if active_author %}author={{ active_author }}{% endif %}" hx-get="?{% if active_category %}category={{ active_category }}{% endif %}{% if active_category and active_author %}&{% endif %}{% if active_author %}author={{ active_author }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                            All
                        </a>
                        {% for tag in tags %}
                            <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if active_tag == tag.slug %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?tag={{ tag.slug }}{% if active_category %}&category={{ active_category }}{% endif %}{% if active_author %}&author={{ active_author }}{% endif %}" hx-get="?tag={{ tag.slug }}{% if active_category %}&category={{ active_category }}{% endif %}{% if active_author %}&author={{ active_author }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                                {{ tag.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if authors %}
                <div class="space-y-3">
                    <h2 class="text-xs font-semibold uppercase tracking-wider text-[#c4582f]">Authors</h2>
                    <div class="flex flex-wrap gap-2">
                        <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if not active_author %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?{% if active_category %}category={{ active_category }}{% endif %}{% if active_category and active_tag %}&{% endif %}{% if active_tag %}tag={{ active_tag }}{% endif %}" hx-get="?{% if active_category %}category={{ active_category }}{% endif %}{% if active_category and active_tag %}&{% endif %}{% if active_tag %}tag={{ active_tag }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                            All
                        </a>
                        {% for author in authors %}
                            <a class="rounded-full border px-3 py-1 text-xs font-semibold {% if active_author == author.author_slug %}border-[#1e1c1a] text-[#1e1c1a]{% else %}border-[#e8dbc9] text-[#4a433b]{% endif %}" href="?author={{ author.author_slug }}{% if active_category %}&category={{ active_category }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}" hx-get="?author={{ author.author_slug }}{% if active_category %}&category={{ active_category }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}" hx-target="#blog-results" hx-swap="outerHTML" hx-push-url="true">
                                {{ author.get_full_name|default:author.username }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <div class="mt-10 grid gap-8 md:grid-cols-2">
        {% for post in posts %}
            <article class="rounded-3xl border border-[#e8dbc9] bg-white shadow-sm transition hover:-translate-y-1">
                {% if post.featured_image %}
                    {% image post.featured_image fill-640x420 as card_img %}
                    <a class="block overflow-hidden rounded-t-3xl" href="{% pageurl post %}">
                        <img class="h-56 w-full object-cover" src="{{ card_img.url }}" alt="{{ post.featured_image.title }}" width="640" height="420">
                    </a>
                {% endif %}
                <div class="space-y-4 p-6">
                    <div class="flex flex-wrap items-center gap-2 text-xs text-[#5b534b]">
                        <span class="rounded-full border border-[#e8dbc9] bg-[#fdf8f1] px-3 py-1">{{ post.date }}</span>
                        {% if post.authors.exists %}
                            <span class="text-[#c4582f]">â€¢</span>
                            <div class="flex flex-wrap items-center gap-3">
                                {% for author in post.authors.all %}
                                    <div class="flex items-center gap-2">
                                        {% if author.wagtail_userprofile.avatar %}
                                            <img class="h-7 w-7 rounded-full border border-[#e8dbc9] object-cover" src="{{ author.wagtail_userprofile.avatar.url }}" alt="{{ author.get_full_name|default:author.username }}" width="28" height="28">
                                        {% endif %}
                                        <a class="text-sm font-semibold text-[#2a7f72] hover:text-[#c4582f]" href="{% routablepageurl page 'author_detail' author.author_slug %}">
                                            {{ author.get_full_name|default:author.username }}
                                        </a>{% if not forloop.last %},{% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <h2 class="text-lg font-semibold text-[#1e1c1a]">
                        <a class="hover:text-[#c4582f]" href="{% pageurl post %}">{{ post.title }}</a>
                    </h2>
                    <p class="text-sm leading-relaxed text-[#4a433b]">{{ post.intro }}</p>
                    {% if post.categories.exists or post.tags.exists %}
                        <div class="flex flex-wrap gap-2">
                            {% for category in post.categories.all %}
                                <span class="rounded-full border border-[#e8dbc9] bg-white px-3 py-1 text-xs font-semibold text-[#1e1c1a]">{{ category.title }}</span>
                            {% endfor %}
                            {% for tag in post.tags.all %}
                                <span class="rounded-full border border-[#c4582f] bg-[#fff7f0] px-3 py-1 text-xs font-semibold text-[#c4582f]">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </article>
        {% empty %}
            <div class="rounded-2xl border border-[#e8dbc9] bg-white p-6 text-sm text-[#4a433b]">No posts match these filters yet.</div>
        {% endfor %}
    </div>
</div>
