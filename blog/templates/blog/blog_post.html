{% extends "base.html" %}

{% load wagtailcore_tags wagtailimages_tags wagtailroutablepage_tags blog_tags %}

{% block body_class %}
template-blogpage
{% endblock body_class %}

{% block content %}
    <article class="bg-[#fdf8f1]">
        {% with blog_index=page.get_parent.specific %}
        <header class="border-b border-[#e8dbc9] bg-[#fdf8f1]">
            <div class="mx-auto grid max-w-5xl gap-10 px-6 py-14 md:grid-cols-[minmax(0,1.2fr)_minmax(0,0.8fr)]">
                <div class="space-y-6">
                    <span class="text-xs uppercase tracking-[0.35em] text-[#c4582f]">Blog post</span>
                    <h1 class="text-3xl font-semibold text-[#1e1c1a] md:text-4xl">{{ page.title }}</h1>
                    <div class="flex flex-wrap items-center gap-3 text-xs text-[#5b534b]">
                        <span class="rounded-full border border-[#e8dbc9] bg-white px-3 py-1">{{ page.date }}</span>
                        {% if page.auto_reading_time and page.reading_time %}
                            <span class="rounded-full border border-[#e8dbc9] bg-white px-3 py-1">{{ page.reading_time }} min read</span>
                        {% endif %}
                        {% if page.authors.exists %}
                            <span class="text-[#c4582f]">â€¢</span>
                            <div class="flex flex-wrap items-center gap-3">
                                {% for author in page.authors.all %}
                                    <div class="flex items-center gap-2">
                                        {% if author.wagtail_userprofile.avatar %}
                                            <img class="h-8 w-8 rounded-full border border-[#e8dbc9] object-cover" src="{{ author.wagtail_userprofile.avatar.url }}" alt="{{ author.get_full_name|default:author.username }}" width="32" height="32">
                                        {% endif %}
                                        <a class="text-sm font-semibold text-[#2a7f72] hover:text-[#c4582f]" href="{% routablepageurl blog_index 'author_detail' author.author_slug %}">
                                            {{ author.get_full_name|default:author.username }}
                                        </a>{% if not forloop.last %},{% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% if page.categories.exists or page.tags.exists %}
                        <div class="flex flex-wrap gap-2">
                            {% for category in page.categories.all %}
                                <span class="rounded-full border border-[#e8dbc9] bg-white px-3 py-1 text-xs font-semibold text-[#1e1c1a]">{{ category.title }}</span>
                            {% endfor %}
                            {% for tag in page.tags.all %}
                                <span class="rounded-full border border-[#c4582f] bg-[#fff7f0] px-3 py-1 text-xs font-semibold text-[#c4582f]">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if page.summary %}
                        <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                            <p>{{ page.summary }}</p>
                        </div>
                    {% endif %}
                    {% if page.authors.count == 1 %}
                        {% with primary_author=page.authors.first %}
                            {% if primary_author.bio %}
                                <div class="rounded-2xl border border-[#e8dbc9] bg-white p-5 text-sm text-[#3f3a33]">
                                    {% for block in primary_author.bio %}
                                        {% include_block block %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                    {% if page.intro %}
                        <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                            {{ page.intro }}
                        </div>
                    {% endif %}
                </div>
                {% if page.featured_image %}
                    {% image page.featured_image fill-720x520 as hero_img %}
                    <div class="overflow-hidden rounded-3xl border border-[#e8dbc9] bg-white shadow-sm">
                        <img class="h-full w-full object-cover" src="{{ hero_img.url }}" alt="{{ page.featured_image.title }}" width="{{ hero_img.width }}" height="{{ hero_img.height }}">
                    </div>
                {% endif %}
            </div>
        </header>

        <div class="mx-auto max-w-3xl px-6 py-12">
            {% if show_toc and blog_toc_items %}
                <aside class="mb-10 rounded-2xl border border-[#e8dbc9] bg-white p-6">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-[#c4582f]">Contents</h2>
                    <ul class="mt-4 space-y-2 text-sm text-[#3f3a33]">
                        {% for item in blog_toc_items %}
                            <li class="{% if item.level == 3 %}pl-4 text-xs{% endif %}">
                                <a class="hover:text-[#c4582f]" href="#{{ item.anchor }}">{{ item.text }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </aside>
            {% endif %}
            <div class="space-y-6 text-[#3f3a33]">
                {% for block in page.body %}
                    {% if block.block_type == "heading" %}
                        {% with rendered_html=blog_toc_rendered|get_item:block.id %}
                            {% if rendered_html %}
                                <div class="rounded-2xl border border-[#e8dbc9] bg-white p-6 shadow-sm">
                                    <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                                        {{ rendered_html|safe }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="rounded-2xl border border-[#e8dbc9] bg-white p-6 shadow-sm">
                                    <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                                        {% include_block block %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% elif block.block_type == "paragraph" %}
                        {% with rendered_html=blog_toc_rendered|get_item:block.id %}
                            <div class="rounded-2xl border border-[#e8dbc9] bg-white p-6 shadow-sm">
                                <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                                    {% if rendered_html %}
                                        {{ rendered_html|richtext }}
                                    {% else %}
                                        {% include_block block %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endwith %}
                    {% else %}
                        <div class="rounded-2xl border border-[#e8dbc9] bg-white p-6 shadow-sm">
                            <div class="prose max-w-none prose-neutral prose-headings:text-[#1e1c1a] prose-a:text-[#2a7f72] prose-a:no-underline prose-a:hover:text-[#c4582f]">
                                {% include_block block %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <a class="mt-10 inline-flex items-center text-sm font-semibold text-[#2a7f72] hover:text-[#c4582f]" href="{{ page.get_parent.url }}">Return to blog</a>
        </div>
        {% endwith %}
    </article>
{% endblock content %}
